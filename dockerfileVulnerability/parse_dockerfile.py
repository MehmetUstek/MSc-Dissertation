import os
from dockerfileVulnerability.dockerfile_node import DockerfileNode

def parse_dockerfile(file_path):
    """Parse Dockerfile contents from a file into an AST."""
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"The specified file does not exist: {file_path}")

    with open(file_path, 'r') as file:
        lines = file.readlines()

    user = ''

    root = DockerfileNode('ROOT', '', user, 1)
    it = iter(lines)


    for i,line in enumerate(it, 1):
        # print("line", line)
        line = line.strip()
        if line and not line.startswith('#'):
            if line.endswith('\\'):
                # Handle multi-line instructions
                full_instruction = line[:-1].strip()
                while line.endswith('\\'):
                    line = next(it).strip()
                    full_instruction += line[:-1].strip()
                line = full_instruction
            parts = line.split(' ', 1)
            if len(parts) > 1:
                instruction, args = parts[0], parts[1].strip()
                if (instruction == "USER"):
                    user = args
                root.add_child(DockerfileNode(instruction, args, user,i))
    return root